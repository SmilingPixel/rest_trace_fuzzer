# Microservice System Testing Tool

This project is a tool designed to test a microservice system. The most novel part of this tool is its ability to utilize traces collected from the system to guide the testing process.

## Table of Contents

- [Introduction](#introduction)
- [Features](#features)
- [Architecture](#architecture)
- [Dependencies](#dependencies)
- [Installation](#installation)
- [Preparation](#preparation)
- [Usage](#usage)
- [Configuration](#configuration)
- [License](#license)

## Introduction

Microservice systems are complex and require thorough testing to ensure reliability and performance. This tool leverages system traces to guide the testing process, providing a more efficient and effective way to identify issues and ensure system robustness.

## Features

- **Trace-Guided Testing**: Utilizes system traces to guide the testing process.
- **Comprehensive Coverage**: Ensures thorough testing of all microservice endpoints.
- **Automated Test Case Generation**: Automatically generates test cases based on system traces.
- **Detailed Reporting**: Provides detailed reports on test coverage and results, including endpoints coverage and internal service coverage.

## Architecture

You can get details of architecture design [here](docs/design.md)

## Dependencies

The tool is still under development, below is our current dependencies:
- X86-64 architecture
- Ubuntu 22.04 LTS
- Go 1.23

We plan to support more architectures and operating systems in the future.


## Installation

To install the tool, follow these steps:

1. Clone the repository:

2. Install dependencies:
    ```sh
    go mod tidy
    ```

## Preparation

1. Prepare the OpenAPI specification file for the system under test. The tool supports OpenAPI 3 by default.
2. Prepare a protobuf file for all RPC which internal services use.
  - We use [protoc-gen-openapi](https://github.com/google/gnostic/tree/main/cmd/protoc-gen-openapi) to convert protobuf to openapi.
  - You should annotate the proto file, and you can refer to this [issue](https://github.com/google/gnostic/issues/412).
3. Ensure that your service includes a unique trace ID in the headers of each response. You can configure the header key in the settings.

## Usage

To use the tool, follow these steps:

1. Build the project:
    ```sh
    make build
    ```

2. Run the tool:
    ```sh
    make run
    ```

3. Clean the project:
    ```sh
    make clean
    ```
    Or you can clean build and output files separately:
    ```sh
    make clean-build
    make clean-output
    ```

In addition, we provide vscode tasks to use the tool. You can build, run and debug the project by selecting the task `Run` in vscode. See the [.vscode/tasks.json](.vscode/tasks.json) file for more details.

## Configuration

The tool can be configured using command-line arguments. The following options are available:

- `--openapi-spec`: Path to the OpenAPI specification file.
- `--server-base-url`: Base URL of the server to test.
- `--internal-service-openapi-spec`: Path to the internal service OpenAPI specification file.
- `--trace-backend-url`: URL of the trace backend.
- `--trace-backend-type`: Type of the trace backend. Currently only supports 'Jaeger'.
- `--fuzzer-type`: Type of fuzzer to use (e.g., Basic).
- `--fuzzer-budget`: Time budget for fuzzing (e.g., 30s).
- `--log-level`: Log level: debug, info, warn, error, fatal, panic.
- `--output-dir`: Directory to save the output reports.
- `--config-file`: Path to the config file. If an argument is provided in both the config file and command line, the config file argument will be used.
- `--dependency-file`: Path to the dependency file generated by other tools or manually.
- `--dependency-file-type`: Type of the dependency file. Currently only supports 'Restler'.
- `--extra-headers`: Extra headers to be added to the request, in the format of stringified JSON, e.g., '{"header1": "value1", "header2": "value2"}'. If you want to add complex logic or modify the parameters and body, you can use the `--http-middleware-script` argument.
- `--fuzz-value-dict-file`: Path to the file containing the dictionary of fuzz values, in the format of a JSON list. Each element in the list is a dictionary with two key-value pairs, one is `name` (value is of type string) and the other is `value` (value can be any JSON).
- `--log-to-file`: Should log to file.
- `--trace-id-header-key`: The response header key to be used for trace ID.
- `--http-middleware-script`: Path to the script file that contains the HTTP middleware functions, see [HTTP Middleware Script](#about-http-middleware-script).

You can also use a configuration file with `--config-file` option to set the options. The configuration file should be in JSON format, we provide an example configuration file [here](configs/config.json).

In addition, for token, private key, or other sensitive information, you can use environment variables. You can set an environment variable with the same name as that in configuration file (but in uppercase) to override the value in the configuration file. For example, you can set `SERVER_BASE_URL` in `.env` file:
```sh
SERVER_BASE_URL=http://localhost:6789
```


## About HTTP Middleware Script

The HTTP Middleware Script allows you to intercept and modify HTTP requests and responses using a Starlark script. The script can modify headers, path parameters, query parameters, and the body of the request.

Here is an example of a Starlark script that modifies the headers, path parameters, query parameters, and body of the request:
```python
# Example Starlark script
headers = {"Authorization": "Bearer new_token"}
pathParams = {"id": "123"}
queryParams = {"search": "new_query"}
body = "[1, 2, 3]"
```

For more information on Starlark, see the [Starlark documentation](https://github.com/google/starlark-go/blob/master/doc/spec.md).

## License

This project is licensed under the GPL-3.0 License - see the [LICENSE](LICENSE) file for details.
